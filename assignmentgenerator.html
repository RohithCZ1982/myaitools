<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assignment Sheet Generator</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Load API Key Configuration -->
    <script src="config.js"></script>
    
    <!-- Load Inter font and custom styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f7f7;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f0f0;
        }
        ::-webkit-scrollbar-thumb {
            background: #6EE7B7;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #34D399;
        }
        
        /* Assignment sheet styling */
        #assignment-sheet {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        
        .question-item {
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .question-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="min-h-screen p-4 flex flex-col items-center justify-start bg-gray-50">

    <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 lg:p-8">
        <!-- Back Button -->
        <a href="index.html" 
           class="inline-flex items-center text-sm text-emerald-600 hover:text-emerald-700 font-medium mb-4 transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Home
        </a>
        
        <h1 class="text-3xl font-extrabold text-gray-800 mb-2">AI Assignment Sheet Generator</h1>
        <p class="text-gray-500 mb-6">Generate customized assignment sheets with questions based on your example.</p>
        
        <!-- API Key Warning -->
        <div id="api-key-warning" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
            <div class="flex items-start">
                <svg class="w-5 h-5 text-yellow-600 mr-2 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                </svg>
                <div class="flex-1">
                    <p class="text-sm font-semibold text-yellow-800">API Key Required</p>
                    <p class="text-xs text-yellow-700 mt-1">Please add your Google Generative AI API key to generate assignments. See <code class="bg-yellow-100 px-1 rounded">API_KEY_SETUP.md</code> for instructions.</p>
                </div>
            </div>
        </div>

        <!-- Input Form -->
        <form id="assignment-form" class="space-y-4">
            
            <!-- Class -->
            <div>
                <label for="class" class="block text-sm font-medium text-gray-700">Class <span class="text-red-500">*</span></label>
                <input type="text" id="class" required placeholder="e.g., Grade 10, Class 5A, Year 12"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
            </div>

            <!-- Subject Module -->
            <div>
                <label for="subject-module" class="block text-sm font-medium text-gray-700">Subject Module <span class="text-red-500">*</span></label>
                <input type="text" id="subject-module" required placeholder="e.g., Mathematics - Algebra, Science - Physics, English Literature"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
            </div>

            <!-- Assignment Checkbox -->
            <div class="mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
                <label class="flex items-center cursor-pointer">
                    <input type="checkbox" id="assignment-checkbox" checked
                           class="w-5 h-5 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500">
                    <span class="ml-3 text-sm font-medium text-gray-700">Assignment (Generate Questions)</span>
                </label>
                <p class="mt-2 text-xs text-gray-500 ml-8">Uncheck to generate a summary instead of questions</p>
            </div>

            <!-- Example Question/Prompt -->
            <div id="example-question-container">
                <label for="example-question" class="block text-sm font-medium text-gray-700">Example Question <span class="text-red-500">*</span></label>
                <textarea id="example-question" required rows="4" placeholder="e.g., Solve for x: 2x + 5 = 15"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"></textarea>
                <p class="mt-1 text-xs text-gray-400">Provide an example question that represents the type and style of questions you want generated.</p>
            </div>

            <!-- Prompt Input (for Summary mode) -->
            <div id="prompt-container" class="hidden">
                <label for="prompt-input" class="block text-sm font-medium text-gray-700">Topic/Prompt <span class="text-red-500">*</span></label>
                <textarea id="prompt-input" rows="4" placeholder="e.g., Explain the water cycle, Describe photosynthesis, etc."
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150"></textarea>
                <p class="mt-1 text-xs text-gray-400">Enter the topic or prompt you want summarized.</p>
            </div>

            <!-- Difficulty/Level Dropdown -->
            <div>
                <label for="difficulty" id="difficulty-label" class="block text-sm font-medium text-gray-700">Question Difficulty <span class="text-red-500">*</span></label>
                <select id="difficulty" required
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
                    <option value="easy" selected>Easy</option>
                    <option value="normal">Normal</option>
                    <option value="difficult">Difficult</option>
                </select>
            </div>

            <!-- Number of Questions -->
            <div id="num-questions-container">
                <label for="num-questions" class="block text-sm font-medium text-gray-700">Number of Questions <span class="text-red-500">*</span></label>
                <input type="number" id="num-questions" required min="1" max="50" value="5" placeholder="e.g., 5"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-emerald-500 focus:border-emerald-500 transition duration-150">
            </div>

            <!-- Generate Button -->
            <button type="submit" id="generate-button"
                    class="w-full py-3 px-4 bg-gradient-to-r from-emerald-500 to-emerald-600 text-white font-semibold rounded-lg shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200 flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                Generate Assignment Sheet
            </button>
        </form>

        <!-- Status Message -->
        <div id="status-message" class="mt-4 hidden p-3 rounded-lg"></div>

        <!-- Loading Indicator -->
        <div id="loading-indicator" class="hidden mt-6 text-center">
            <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
            <p class="mt-2 text-gray-600">Generating assignment questions...</p>
        </div>

        <!-- Output Area -->
        <div id="output-area" class="mt-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Generated Assignment Sheet</h2>
                <div class="flex gap-2">
                    <button id="generate-answers-button" class="hidden inline-flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Generate Answers
                    </button>
                    <button id="download-pdf-button"
                            class="inline-flex items-center px-4 py-2 bg-emerald-600 text-white font-semibold rounded-lg shadow hover:bg-emerald-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export Questions to PDF
                    </button>
                </div>
            </div>
            <div id="assignment-sheet" class="bg-white border border-gray-200 rounded-lg p-6">
                <!-- Assignment content will be inserted here -->
            </div>
        </div>
        
        <!-- Answers Area (hidden by default, outside output-area) -->
        <div id="answers-area" class="mt-6 hidden">
            <div class="w-full max-w-4xl bg-white shadow-xl rounded-2xl p-6 lg:p-8">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-gray-800">Answer Key</h2>
                    <button id="download-answers-pdf-button"
                            class="inline-flex items-center px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg shadow hover:bg-blue-700 transition-colors duration-200">
                        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                        </svg>
                        Export Answers to PDF
                    </button>
                </div>
                <div id="answers-sheet" class="bg-white border border-gray-200 rounded-lg p-6">
                    <!-- Answers content will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // Check if user came from index.html - redirect if not
        // This check runs when DOM is ready to ensure sessionStorage is available
        document.addEventListener('DOMContentLoaded', function() {
            const indexPage = 'index.html';
            
            const allowedAccess = sessionStorage.getItem('allowedAccess');
            
            if (allowedAccess !== 'true') {
                window.location.replace(indexPage);
                return;
            }
            
            // Clear the flag after checking to prevent reuse
            sessionStorage.removeItem('allowedAccess');
        });

        const form = document.getElementById('assignment-form');
        const classInput = document.getElementById('class');
        const subjectModuleInput = document.getElementById('subject-module');
        const exampleQuestionInput = document.getElementById('example-question');
        const promptInput = document.getElementById('prompt-input');
        const assignmentCheckbox = document.getElementById('assignment-checkbox');
        const exampleQuestionContainer = document.getElementById('example-question-container');
        const promptContainer = document.getElementById('prompt-container');
        const difficultyInput = document.getElementById('difficulty');
        const difficultyLabel = document.getElementById('difficulty-label');
        const numQuestionsInput = document.getElementById('num-questions');
        const numQuestionsContainer = document.getElementById('num-questions-container');
        const generateButton = document.getElementById('generate-button');
        const outputArea = document.getElementById('output-area');
        const downloadPdfButton = document.getElementById('download-pdf-button');
        const generateAnswersButton = document.getElementById('generate-answers-button');
        const answersArea = document.getElementById('answers-area');
        const answersSheet = document.getElementById('answers-sheet');
        const downloadAnswersPdfButton = document.getElementById('download-answers-pdf-button');
        const statusMessage = document.getElementById('status-message');
        const loadingIndicator = document.getElementById('loading-indicator');
        const apiKeyWarning = document.getElementById('api-key-warning');
        const assignmentSheet = document.getElementById('assignment-sheet');
        
        // Store current questions for answer generation
        let currentQuestions = [];

        // ============================================
        // API KEY SETUP INSTRUCTIONS:
        // 
        // OPTION 1: Google Gemini API (Recommended - Free tier available)
        // 1. Go to: https://console.cloud.google.com/
        // 2. Create a new project
        // 3. Enable "Generative Language API"
        // 4. Create credentials → API Key
        // 5. Copy your API key and encode it using: btoa("YOUR_API_KEY")
        // 6. Paste the encoded key in the encodedApiKey variable below
        //
        // OPTION 2: OpenAI API (Alternative - Paid, but very reliable)
        // 1. Go to: https://platform.openai.com/api-keys
        // 2. Create an API key
        // 3. Encode it using: btoa("YOUR_OPENAI_API_KEY")
        // 4. Set useOpenAI = true and paste encoded key in openAIApiKey below
        //
        // OPTION 3: Anthropic Claude API (Alternative - Paid)
        // 1. Go to: https://console.anthropic.com/
        // 2. Create an API key
        // 3. Encode it using: btoa("YOUR_ANTHROPIC_API_KEY")
        // 4. Set useAnthropic = true and paste encoded key in anthropicApiKey below
        // ============================================
        
        // API Provider Selection
        const USE_OPENAI = false; // Set to true to use OpenAI instead
        const USE_ANTHROPIC = false; // Set to true to use Anthropic Claude instead
        
        // Get API key from config.js
        const apiKey = CONFIG.getApiKey();
        
        // OpenAI API Key (Alternative)
        const encodedOpenAIApiKey = ""; // ⚠️ ADD YOUR ENCODED OPENAI API KEY HERE (if using OpenAI)
        const openAIApiKey = encodedOpenAIApiKey ? atob(encodedOpenAIApiKey) : "";
        
        // Anthropic Claude API Key (Alternative)
        const encodedAnthropicApiKey = ""; // ⚠️ ADD YOUR ENCODED ANTHROPIC API KEY HERE (if using Anthropic)
        const anthropicApiKey = encodedAnthropicApiKey ? atob(encodedAnthropicApiKey) : "";
        
        // Google Generative AI API endpoint (using Gemini)
        const getApiUrl = (modelName = 'gemini-1.5-flash', useV1 = false) => {
            const apiVersion = useV1 ? 'v1' : 'v1beta';
            return `https://generativelanguage.googleapis.com/${apiVersion}/models/${modelName}:generateContent?key=${apiKey}`;
        };
        
        const MAX_RETRIES = 3;
        // List of models to try in order (v1beta has better model support)
        // Only using v1beta as v1 has limited model availability
        const MODEL_OPTIONS = [
            { name: 'gemini-2.5-flash', v1: false },  // v1beta - fastest, most commonly available
            { name: 'gemini-1.5-pro', v1: false },    // v1beta - better quality
        ];

        // Check if API key is set
        if (!apiKey || apiKey.trim() === '') {
            apiKeyWarning.classList.remove('hidden');
        } else {
            // List available models on page load (for debugging)
            listAvailableModels();
        }

        /**
         * Toggle between Assignment and Summary modes
         */
        function toggleMode() {
            const isAssignment = assignmentCheckbox.checked;
            
            if (isAssignment) {
                // Assignment mode - show question input, difficulty options, number of questions
                exampleQuestionContainer.classList.remove('hidden');
                promptContainer.classList.add('hidden');
                numQuestionsContainer.classList.remove('hidden');
                
                // Update dropdown for assignment mode
                difficultyLabel.textContent = 'Question Difficulty *';
                difficultyInput.innerHTML = `
                    <option value="easy" selected>Easy</option>
                    <option value="normal">Normal</option>
                    <option value="difficult">Difficult</option>
                `;
                
                // Make example question required, prompt not required
                exampleQuestionInput.required = true;
                promptInput.required = false;
                
                // Update button text
                generateButton.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Generate Assignment Sheet
                `;
            } else {
                // Summary mode - show prompt input, summary level options, hide number of questions
                exampleQuestionContainer.classList.add('hidden');
                promptContainer.classList.remove('hidden');
                numQuestionsContainer.classList.add('hidden');
                
                // Update dropdown for summary mode
                difficultyLabel.textContent = 'Summary Level *';
                difficultyInput.innerHTML = `
                    <option value="short" selected>Short</option>
                    <option value="summary">Summary</option>
                    <option value="indetail">In Detail</option>
                `;
                
                // Make prompt required, example question not required
                promptInput.required = true;
                exampleQuestionInput.required = false;
                
                // Update button text
                generateButton.innerHTML = `
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                    </svg>
                    Generate Summary
                `;
                
                // Hide answers button in summary mode
                generateAnswersButton.classList.add('hidden');
                answersArea.classList.add('hidden');
            }
        }

        // Add event listener for checkbox
        assignmentCheckbox.addEventListener('change', toggleMode);
        
        // Initialize mode on page load
        toggleMode();

        /**
         * Shows loading state
         */
        function showLoading() {
            generateButton.disabled = true;
            generateButton.innerHTML = `
                <div class="inline-block animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                Generating...
            `;
            loadingIndicator.classList.remove('hidden');
            outputArea.classList.add('hidden');
            statusMessage.classList.add('hidden');
        }

        /**
         * Hides loading state
         */
        function hideLoading() {
            generateButton.disabled = false;
            const isAssignment = assignmentCheckbox.checked;
            generateButton.innerHTML = `
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                </svg>
                ${isAssignment ? 'Generate Assignment Sheet' : 'Generate Summary'}
            `;
            loadingIndicator.classList.add('hidden');
        }

        /**
         * Shows status message
         */
        function showStatus(message, isError = false) {
            statusMessage.textContent = message;
            statusMessage.className = isError 
                ? 'mt-4 p-3 bg-red-50 border border-red-200 text-red-800 rounded-lg' 
                : 'mt-4 p-3 bg-green-50 border border-green-200 text-green-800 rounded-lg';
            statusMessage.classList.remove('hidden');
        }

        /**
         * Lists available models (helper function for debugging)
         */
        async function listAvailableModels() {
            if (!apiKey || apiKey.trim() === '') {
                console.warn('API key not set, cannot list models');
                return;
            }
            
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${apiKey}`);
                const data = await response.json();
                if (data.models) {
                    console.log('Available models:', data.models.map(m => m.name).join(', '));
                }
            } catch (error) {
                console.warn('Could not list models:', error);
            }
        }

        /**
         * Generates questions or summary using AI API (supports Google Gemini, OpenAI, or Anthropic)
         */
        async function generateContent(classValue, subjectModule, isAssignment, exampleQuestionOrPrompt, difficultyOrLevel, numQuestions, attempt = 1, modelIndex = 0) {
            let prompt;
            
            if (isAssignment) {
                // Assignment mode - generate questions
                prompt = `You are an expert educator creating an assignment sheet. Generate exactly ${numQuestions} questions for ${classValue} students studying ${subjectModule}.

Example question style:
${exampleQuestionOrPrompt}

Requirements:
- Difficulty level: ${difficultyOrLevel}
- All questions should be similar in style and format to the example question
- Questions should be appropriate for ${classValue} level
- Each question should be clear, well-formatted, and educational
- Number each question starting from 1 using the format: "1. [question text]"
- Do NOT include any headings, titles, or introductory text
- Do NOT include explanations or answers
- Output ONLY the numbered questions, one per line
- Format: Start each question with its number followed by a period and space (e.g., "1. ", "2. ", etc.)

Generate exactly ${numQuestions} questions in this format:`;
            } else {
                // Summary mode - generate summary
                const levelMap = {
                    'short': 'brief and concise',
                    'summary': 'moderate length with key points',
                    'indetail': 'comprehensive and detailed'
                };
                const levelDescription = levelMap[difficultyOrLevel] || 'moderate length';
                
                prompt = `You are an expert educator creating educational content for ${classValue} students studying ${subjectModule}.

Topic/Prompt:
${exampleQuestionOrPrompt}

Requirements:
- Create a ${levelDescription} summary of the topic
- The summary should be appropriate for ${classValue} level students
- Make it clear, well-structured, and educational
- Use proper formatting with paragraphs
- Do NOT include headings or titles
- Focus on key concepts and important information

Generate the summary:`;
            }

            // Try OpenAI first if enabled
            if (USE_OPENAI && openAIApiKey) {
                return await generateWithOpenAI(prompt, attempt);
            }
            
            // Try Anthropic if enabled
            if (USE_ANTHROPIC && anthropicApiKey) {
                return await generateWithAnthropic(prompt, attempt);
            }
            
            // Default to Google Gemini
            if (!apiKey || apiKey.trim() === '') {
                throw new Error('API key is not set. Please add your Google Generative AI API key, or enable OpenAI/Anthropic.');
            }

            // Try next model if current one fails
            if (modelIndex >= MODEL_OPTIONS.length) {
                throw new Error('All available models failed. Please check your API key and model availability.');
            }

            const currentModelConfig = MODEL_OPTIONS[modelIndex];
            const apiUrl = getApiUrl(currentModelConfig.name, currentModelConfig.v1);

            const payload = {
                contents: [{
                    parts: [{
                        text: prompt
                    }]
                }],
                generationConfig: {
                    temperature: 0.7,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 2048,
                }
            };

            try {
                console.log(`Sending request to generate questions using model: ${currentModelConfig.name} (${currentModelConfig.v1 ? 'v1' : 'v1beta'})...`);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();
                console.log('API Response status:', response.status);

                if (!response.ok) {
                    console.error('API Error Response:', responseData);
                    let errorMessage = responseData.error?.message || responseData.message || `HTTP error! status: ${response.status}`;
                    
                    // If model not found, try next model
                    if (errorMessage.includes('not found') || errorMessage.includes('not supported') || errorMessage.includes('Call ListModels') || response.status === 404) {
                        console.log(`Model ${currentModelConfig.name} (${currentModelConfig.v1 ? 'v1' : 'v1beta'}) not available, trying next model...`);
                        if (modelIndex < MODEL_OPTIONS.length - 1) {
                            return generateContent(classValue, subjectModule, isAssignment, exampleQuestionOrPrompt, difficultyOrLevel, numQuestions, 1, modelIndex + 1);
                        } else {
                            // If all models failed, suggest using alternative API
                            throw new Error(`All Gemini models failed. Error: ${errorMessage}. Consider using OpenAI or Anthropic API instead. See code comments for setup instructions.`);
                        }
                    }
                    
                    throw new Error(errorMessage);
                }

                if (responseData.candidates && responseData.candidates.length > 0 && responseData.candidates[0].content) {
                    const generatedText = responseData.candidates[0].content.parts[0].text;
                    return generatedText;
                } else {
                    console.error('Unexpected API response format:', responseData);
                    throw new Error("API did not return text in expected format.");
                }
            } catch (error) {
                console.error(`Attempt ${attempt} failed with model ${currentModelConfig.name}:`, error);
                if (error.message.includes('API key')) {
                    throw error;
                }
                
                // If model not found error, try next model
                if (error.message.includes('not found') || error.message.includes('not supported')) {
                    if (modelIndex < MODEL_OPTIONS.length - 1) {
                        return generateContent(classValue, subjectModule, isAssignment, exampleQuestionOrPrompt, difficultyOrLevel, numQuestions, 1, modelIndex + 1);
                    }
                }
                
                if (attempt < MAX_RETRIES) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateContent(classValue, subjectModule, isAssignment, exampleQuestionOrPrompt, difficultyOrLevel, numQuestions, attempt + 1, modelIndex);
                } else {
                    throw error;
                }
            }
        }

        /**
         * Generates questions using OpenAI API
         */
        async function generateWithOpenAI(prompt, attempt = 1) {
            if (!openAIApiKey || openAIApiKey.trim() === '') {
                throw new Error('OpenAI API key is not set.');
            }

            const payload = {
                model: 'gpt-3.5-turbo',
                messages: [
                    { role: 'system', content: 'You are an expert educator creating assignment questions.' },
                    { role: 'user', content: prompt }
                ],
                temperature: 0.7,
                max_tokens: 2000
            };

            try {
                console.log('Sending request to OpenAI...');
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${openAIApiKey}`
                    },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(responseData.error?.message || `OpenAI API error: ${response.status}`);
                }

                if (responseData.choices && responseData.choices.length > 0) {
                    return responseData.choices[0].message.content;
                } else {
                    throw new Error("OpenAI did not return text in expected format.");
                }
            } catch (error) {
                console.error(`OpenAI attempt ${attempt} failed:`, error);
                if (attempt < MAX_RETRIES && !error.message.includes('API key')) {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateWithOpenAI(prompt, attempt + 1);
                }
                throw error;
            }
        }

        /**
         * Generates questions using Anthropic Claude API
         */
        async function generateWithAnthropic(prompt, attempt = 1) {
            if (!anthropicApiKey || anthropicApiKey.trim() === '') {
                throw new Error('Anthropic API key is not set.');
            }

            const payload = {
                model: 'claude-3-haiku-20240307',
                max_tokens: 2000,
                messages: [
                    { role: 'user', content: prompt }
                ]
            };

            try {
                console.log('Sending request to Anthropic...');
                
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': anthropicApiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(responseData.error?.message || `Anthropic API error: ${response.status}`);
                }

                if (responseData.content && responseData.content.length > 0) {
                    return responseData.content[0].text;
                } else {
                    throw new Error("Anthropic did not return text in expected format.");
                }
            } catch (error) {
                console.error(`Anthropic attempt ${attempt} failed:`, error);
                if (attempt < MAX_RETRIES && !error.message.includes('API key')) {
                    const delay = Math.pow(2, attempt) * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return generateWithAnthropic(prompt, attempt + 1);
                }
                throw error;
            }
        }

        /**
         * Parses the generated text into individual questions
         */
        function parseQuestions(text) {
            // Remove common headings and non-question text
            const headingPatterns = [
                /^assignment\s+sheet/i,
                /^questions?:?/i,
                /^generated\s+questions?:?/i,
                /^here\s+are\s+the\s+questions?:?/i,
                /^the\s+questions?\s+are:?/i,
                /^below\s+are\s+the\s+questions?:?/i,
                /^class:?/i,
                /^subject:?/i,
                /^module:?/i,
                /^difficulty:?/i,
                /^requirements?:?/i
            ];
            
            // Split by lines and filter
            const lines = text.split('\n').map(line => line.trim()).filter(line => line.length > 0);
            const questions = [];
            let currentQuestion = '';
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                
                // Skip lines that are clearly headings
                let isHeading = false;
                for (let pattern of headingPatterns) {
                    if (pattern.test(line) && line.length < 100) {
                        isHeading = true;
                        break;
                    }
                }
                if (isHeading) continue;
                
                // Check if line starts with a number (question format: "1. ", "2. ", etc.)
                const numberedQuestionMatch = line.match(/^(\d+)[\.\)]\s+(.+)$/);
                if (numberedQuestionMatch) {
                    // If we have a previous question, save it
                    if (currentQuestion.trim()) {
                        questions.push(currentQuestion.trim());
                        currentQuestion = '';
                    }
                    // Start new question
                    currentQuestion = numberedQuestionMatch[2];
                } 
                // Check for Q1, Q2 format
                else if (/^[Qq](\d+)[\.\):]\s+(.+)$/.test(line)) {
                    if (currentQuestion.trim()) {
                        questions.push(currentQuestion.trim());
                        currentQuestion = '';
                    }
                    currentQuestion = line.replace(/^[Qq]\d+[\.\):]\s*/, '');
                }
                // Check if line looks like a question (has question mark and reasonable length)
                else if (line.includes('?') && line.length > 15 && line.length < 500) {
                    // If it doesn't start with a number, it might be a continuation or standalone
                    if (currentQuestion.trim()) {
                        // Check if it's a continuation (no number, reasonable length)
                        if (!/^\d+[\.\)]/.test(line)) {
                            currentQuestion += ' ' + line;
                        } else {
                            // It's a new question
                            questions.push(currentQuestion.trim());
                            currentQuestion = line.replace(/^\d+[\.\)]\s*/, '');
                        }
                    } else {
                        // Start new question (might be unnumbered)
                        currentQuestion = line.replace(/^\d+[\.\)]\s*/, '').replace(/^[Qq]\d+[\.\):]\s*/, '');
                    }
                }
                // If we have a current question and this line doesn't look like a new question, append it
                else if (currentQuestion.trim() && line.length > 0 && line.length < 300) {
                    // Append continuation (but not if it looks like a new numbered question)
                    if (!/^\d+[\.\)]\s/.test(line) && !/^[Qq]\d+[\.\):]\s/.test(line)) {
                        currentQuestion += ' ' + line;
                    } else {
                        // It's a new question
                        questions.push(currentQuestion.trim());
                        currentQuestion = line.replace(/^\d+[\.\)]\s*/, '').replace(/^[Qq]\d+[\.\):]\s*/, '');
                    }
                }
            }
            
            // Add the last question if exists
            if (currentQuestion.trim()) {
                questions.push(currentQuestion.trim());
            }
            
            // Filter out questions that are too short or look like headings
            return questions
                .filter(q => {
                    const trimmed = q.trim();
                    // Must be at least 10 characters
                    if (trimmed.length < 10) return false;
                    // Should contain some question-like content (question mark or question words)
                    if (!trimmed.includes('?') && 
                        !/\b(what|where|when|who|why|how|solve|calculate|find|determine|explain|describe|list|name)\b/i.test(trimmed)) {
                        // Might still be valid if it's long enough
                        return trimmed.length > 20;
                    }
                    // Filter out common heading patterns
                    for (let pattern of headingPatterns) {
                        if (pattern.test(trimmed) && trimmed.length < 100) return false;
                    }
                    return true;
                })
                .map(q => q.trim());
        }

        /**
         * Renders the summary sheet
         */
        function renderSummarySheet(classValue, subjectModule, summaryText, level) {
            const date = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            const levelLabels = {
                'short': 'Short Summary',
                'summary': 'Summary',
                'indetail': 'Detailed Summary'
            };

            let html = `
                <div style="margin-bottom: 2rem;">
                    <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; text-align: center;">${levelLabels[level] || 'Summary'}</h1>
                    <div style="text-align: center; color: #6b7280; margin-bottom: 1rem;">
                        <p style="margin: 0.25rem 0;"><strong>Class:</strong> ${classValue}</p>
                        <p style="margin: 0.25rem 0;"><strong>Subject Module:</strong> ${subjectModule}</p>
                        <p style="margin: 0.25rem 0;"><strong>Date:</strong> ${date}</p>
                    </div>
                </div>
                <div style="margin-top: 2rem;">
                    <div style="line-height: 1.8; color: #374151;">
                        ${summaryText.split('\n').map(para => {
                            const trimmed = para.trim();
                            if (!trimmed) return '';
                            return `<p style="margin-bottom: 1rem;">${trimmed}</p>`;
                        }).join('')}
                    </div>
                </div>
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 0.875rem;">
                    <p>End of Summary</p>
                </div>
            `;

            assignmentSheet.innerHTML = html;
        }

        /**
         * Generates answers for the questions using AI
         */
        async function generateAnswers(questions, classValue, subjectModule, difficulty) {
            if (!apiKey || apiKey.trim() === '') {
                throw new Error('API key is not set. Please add your Google Generative AI API key in config.js.');
            }

            const questionsText = questions.map((q, i) => `${i + 1}. ${q}`).join('\n');
            
            const prompt = `You are an expert educator. Provide comprehensive answers to the following assignment questions for ${classValue} students studying ${subjectModule}.

The questions are at ${difficulty} difficulty level.

Questions:
${questionsText}

Please provide detailed, accurate answers for each question. Format your response as:
1. [Answer to question 1]
2. [Answer to question 2]
...and so on.

Make sure each answer is:
- Clear and well-explained
- Appropriate for ${classValue} level
- Complete and accurate
- Educational and helpful

Provide the answers:`;

            const currentModelConfig = MODEL_OPTIONS[0];
            const apiUrl = getApiUrl(currentModelConfig.name, currentModelConfig.v1);

            const payload = {
                contents: [{
                    parts: [{ text: prompt }]
                }],
                generationConfig: {
                    temperature: 0.3,
                    topK: 40,
                    topP: 0.95,
                    maxOutputTokens: 4096,
                }
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const responseData = await response.json();

                if (!response.ok) {
                    throw new Error(responseData.error?.message || `HTTP error! status: ${response.status}`);
                }

                if (responseData.candidates && responseData.candidates.length > 0 && responseData.candidates[0].content) {
                    return responseData.candidates[0].content.parts[0].text;
                } else {
                    throw new Error("API did not return text in expected format.");
                }
            } catch (error) {
                console.error('Error generating answers:', error);
                throw error;
            }
        }

        /**
         * Renders the answers sheet
         */
        function renderAnswersSheet(classValue, subjectModule, answersText) {
            const date = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Process the answers text line by line
            const lines = answersText.split('\n');
            let html = '';
            let inList = false;
            let currentList = '';

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                
                if (!line) {
                    if (inList && currentList) {
                        html += `<ul style="list-disc; margin-left: 1.5rem; margin-bottom: 1rem;">${currentList}</ul>`;
                        currentList = '';
                        inList = false;
                    }
                    continue;
                }

                // Check for numbered answers (1., 2., etc.)
                const numberedMatch = line.match(/^(\d+)\.\s*(.+)$/);
                if (numberedMatch) {
                    if (inList && currentList) {
                        html += `<ul style="list-disc; margin-left: 1.5rem; margin-bottom: 1rem;">${currentList}</ul>`;
                        currentList = '';
                        inList = false;
                    }
                    const answerNum = numberedMatch[1];
                    const answerText = numberedMatch[2];
                    html += `
                        <div style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
                            <p style="margin: 0; line-height: 1.6; color: #374151;">
                                <strong style="color: #1f2937;">${answerNum}.</strong> ${answerText.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: #1f2937;">$1</strong>')}
                            </p>
                        </div>
                    `;
                    continue;
                }

                // Check for list items
                if (line.match(/^[-*]\s/) || line.match(/^\d+[\.\)]\s/)) {
                    if (!inList) {
                        inList = true;
                        currentList = '';
                    }
                    const listText = line.replace(/^[-*]\s*/, '').replace(/^\d+[\.\)]\s*/, '');
                    currentList += `<li style="margin-bottom: 0.5rem; line-height: 1.6; color: #374151;">${listText.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: #1f2937;">$1</strong>')}</li>`;
                    continue;
                }

                // Regular paragraph
                if (inList && currentList) {
                    html += `<ul style="list-disc; margin-left: 1.5rem; margin-bottom: 1rem;">${currentList}</ul>`;
                    currentList = '';
                    inList = false;
                }

                // Check for headers
                if (line.startsWith('###')) {
                    html += `<h3 style="font-size: 1.25rem; font-weight: bold; margin-top: 1.5rem; margin-bottom: 0.75rem; color: #1f2937;">${line.replace(/^###\s*/, '')}</h3>`;
                } else if (line.startsWith('##')) {
                    html += `<h2 style="font-size: 1.5rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; color: #1f2937;">${line.replace(/^##\s*/, '')}</h2>`;
                } else if (line.startsWith('#')) {
                    html += `<h1 style="font-size: 1.875rem; font-weight: bold; margin-top: 2rem; margin-bottom: 1rem; color: #1f2937;">${line.replace(/^#\s*/, '')}</h1>`;
                } else {
                    html += `<p style="margin-bottom: 1rem; line-height: 1.6; color: #374151;">${line.replace(/\*\*(.*?)\*\*/g, '<strong style="font-weight: 600; color: #1f2937;">$1</strong>')}</p>`;
                }
            }

            // Close any remaining list
            if (inList && currentList) {
                html += `<ul style="list-disc; margin-left: 1.5rem; margin-bottom: 1rem;">${currentList}</ul>`;
            }

            const headerHtml = `
                <div style="margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 2px solid #10b981;">
                    <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; text-align: center;">Answer Key</h1>
                    <div style="text-align: center; color: #6b7280; margin-bottom: 1rem;">
                        <p style="margin: 0.25rem 0;"><strong>Class:</strong> ${classValue}</p>
                        <p style="margin: 0.25rem 0;"><strong>Subject Module:</strong> ${subjectModule}</p>
                        <p style="margin: 0.25rem 0;"><strong>Date:</strong> ${date}</p>
                    </div>
                </div>
            `;

            // If no HTML was generated, use the raw text as fallback
            if (!html || html.trim().length === 0) {
                html = `<div style="line-height: 1.8; color: #374151;">${answersText.split('\n').map(line => {
                    const trimmed = line.trim();
                    if (!trimmed) return '';
                    return `<p style="margin-bottom: 1rem;">${trimmed}</p>`;
                }).join('')}</div>`;
            }

            answersSheet.innerHTML = headerHtml + html;
            
            // Debug: log to console
            console.log('Answers rendered:', answersSheet.innerHTML.length, 'characters');
            console.log('Answers HTML:', answersSheet.innerHTML.substring(0, 200));
            console.log('Answers area element:', answersArea);
            console.log('Answers area classes:', answersArea.className);
        }

        /**
         * Renders the assignment sheet
         */
        function renderAssignmentSheet(classValue, subjectModule, questions) {
            const date = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            let html = `
                <div style="margin-bottom: 2rem;">
                    <h1 style="font-size: 1.5rem; font-weight: bold; margin-bottom: 0.5rem; text-align: center;">Assignment Sheet</h1>
                    <div style="text-align: center; color: #6b7280; margin-bottom: 1rem;">
                        <p style="margin: 0.25rem 0;"><strong>Class:</strong> ${classValue}</p>
                        <p style="margin: 0.25rem 0;"><strong>Subject Module:</strong> ${subjectModule}</p>
                        <p style="margin: 0.25rem 0;"><strong>Date:</strong> ${date}</p>
                    </div>
                </div>
                <div style="margin-top: 2rem;">
            `;

            questions.forEach((question, index) => {
                html += `
                    <div class="question-item" style="margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid #e5e7eb;">
                        <p style="margin: 0; line-height: 1.6;">
                            <strong>${index + 1}.</strong> ${question}
                        </p>
                    </div>
                `;
            });

            html += `
                </div>
                <div style="margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; text-align: center; color: #6b7280; font-size: 0.875rem;">
                    <p>Good luck with your assignment!</p>
                </div>
            `;

            assignmentSheet.innerHTML = html;
        }

        /**
         * Exports assignment sheet or summary to PDF
         */
        function exportToPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            const isAssignment = assignmentCheckbox.checked;
            const classValue = classInput.value;
            const subjectModule = subjectModuleInput.value;
            const date = new Date().toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });

            // Set font
            doc.setFont('helvetica');
            
            if (isAssignment) {
                // Export questions
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Assignment Sheet', 105, 20, { align: 'center' });
                
                // Class, Subject, Date
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Class: ${classValue}`, 105, 30, { align: 'center' });
                doc.text(`Subject Module: ${subjectModule}`, 105, 36, { align: 'center' });
                doc.text(`Date: ${date}`, 105, 42, { align: 'center' });
                
                // Get questions from the rendered sheet
                const questionItems = assignmentSheet.querySelectorAll('.question-item');
                const questions = Array.from(questionItems).map(item => {
                    const text = item.textContent.trim();
                    return text.replace(/^\d+\.\s*/, '');
                });
                
                // Questions
                let yPos = 55;
                doc.setFontSize(11);
                
                questions.forEach((question, index) => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const lines = doc.splitTextToSize(`${index + 1}. ${question}`, 180);
                    
                    lines.forEach((line) => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, 15, yPos);
                        yPos += 6;
                    });
                    
                    yPos += 4;
                });
                
                // Footer
                const pageCount = doc.internal.pages.length - 1;
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.text('Good luck with your assignment!', 105, 285, { align: 'center' });
                }
                
                const fileName = `Assignment_${classValue.replace(/\s+/g, '_')}_${date.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            } else {
                // Export summary
                const level = difficultyInput.value;
                const levelLabels = {
                    'short': 'Short Summary',
                    'summary': 'Summary',
                    'indetail': 'Detailed Summary'
                };
                
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text(levelLabels[level] || 'Summary', 105, 20, { align: 'center' });
                
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Class: ${classValue}`, 105, 30, { align: 'center' });
                doc.text(`Subject Module: ${subjectModule}`, 105, 36, { align: 'center' });
                doc.text(`Date: ${date}`, 105, 42, { align: 'center' });
                
                // Get summary text
                const summaryText = assignmentSheet.textContent || assignmentSheet.innerText;
                const paragraphs = summaryText.split('\n').filter(p => p.trim());
                
                let yPos = 55;
                doc.setFontSize(11);
                
                paragraphs.forEach(para => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const lines = doc.splitTextToSize(para.trim(), 180);
                    lines.forEach(line => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, 15, yPos);
                        yPos += 6;
                    });
                    
                    yPos += 4; // Space between paragraphs
                });
                
                // Footer
                const pageCount = doc.internal.pages.length - 1;
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.text('End of Summary', 105, 285, { align: 'center' });
                }
                
                const fileName = `Summary_${classValue.replace(/\s+/g, '_')}_${date.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
            }
        }

        /**
         * Form submission handler
         */
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (!apiKey || apiKey.trim() === '') {
                showStatus("Please add your Google Generative AI API key in the code to generate assignments.", true);
                return;
            }
            
            const isAssignment = assignmentCheckbox.checked;
            const classValue = classInput.value.trim();
            const subjectModule = subjectModuleInput.value.trim();
            const difficultyOrLevel = difficultyInput.value;
            
            let exampleQuestionOrPrompt;
            let numQuestions = 1; // Default for summary
            
            if (isAssignment) {
                exampleQuestionOrPrompt = exampleQuestionInput.value.trim();
                numQuestions = parseInt(numQuestionsInput.value);
                
                if (!classValue || !subjectModule || !exampleQuestionOrPrompt || !difficultyOrLevel || !numQuestions) {
                    showStatus("Please fill in all required fields.", true);
                    return;
                }
                
                if (numQuestions < 1 || numQuestions > 50) {
                    showStatus("Number of questions must be between 1 and 50.", true);
                    return;
                }
            } else {
                exampleQuestionOrPrompt = promptInput.value.trim();
                
                if (!classValue || !subjectModule || !exampleQuestionOrPrompt || !difficultyOrLevel) {
                    showStatus("Please fill in all required fields.", true);
                    return;
                }
            }

            showLoading();

            try {
                const generatedText = await generateContent(classValue, subjectModule, isAssignment, exampleQuestionOrPrompt, difficultyOrLevel, numQuestions);
                console.log('Generated text:', generatedText); // Debug log
                
                if (isAssignment) {
                    // Parse and render questions
                    const questions = parseQuestions(generatedText);
                    console.log('Parsed questions:', questions); // Debug log
                    console.log(`Found ${questions.length} questions, requested ${numQuestions}`);
                    
                    // Ensure we have the right number of questions
                    if (questions.length < numQuestions) {
                        console.warn(`Generated ${questions.length} questions, requested ${numQuestions}`);
                        showStatus(`Warning: Only ${questions.length} questions were parsed. The AI may not have generated enough questions or the format was unclear.`, true);
                    }
                    
                    // Take only the requested number (or all if we have fewer)
                    const finalQuestions = questions.slice(0, numQuestions);
                    
                    if (finalQuestions.length === 0) {
                        throw new Error("No questions were generated. Please try again with a different example question. The AI response may not have been in the expected format.");
                    }

                    // Store questions for answer generation
                    currentQuestions = finalQuestions;
                    
                    renderAssignmentSheet(classValue, subjectModule, finalQuestions);
                    outputArea.classList.remove('hidden');
                    generateAnswersButton.classList.remove('hidden'); // Show answers button for assignment mode
                    answersArea.classList.add('hidden'); // Hide answers area initially
                    showStatus(`Successfully generated ${finalQuestions.length} question${finalQuestions.length !== 1 ? 's' : ''}!`, false);
                } else {
                    // Render summary
                    renderSummarySheet(classValue, subjectModule, generatedText, difficultyOrLevel);
                    outputArea.classList.remove('hidden');
                    showStatus('Successfully generated summary!', false);
                }
            } catch (error) {
                console.error('Error generating assignment:', error);
                showStatus(`Error: ${error.message}`, true);
                outputArea.classList.add('hidden');
            } finally {
                hideLoading();
            }
        });

        // PDF export button handler
        downloadPdfButton.addEventListener('click', () => {
            try {
                exportToPDF();
                showStatus("PDF exported successfully!", false);
            } catch (error) {
                console.error('Error exporting PDF:', error);
                showStatus(`Error exporting PDF: ${error.message}`, true);
            }
        });

        // Generate answers button handler
        generateAnswersButton.addEventListener('click', async () => {
            if (currentQuestions.length === 0) {
                showStatus("No questions available. Please generate questions first.", true);
                return;
            }

            const classValue = classInput.value.trim();
            const subjectModule = subjectModuleInput.value.trim();
            const difficulty = difficultyInput.value;

            showLoading();
            generateAnswersButton.disabled = true;

            try {
                const answersText = await generateAnswers(currentQuestions, classValue, subjectModule, difficulty);
                console.log('Generated answers text length:', answersText.length);
                console.log('Generated answers text preview:', answersText.substring(0, 200));
                
                if (!answersText || answersText.trim().length === 0) {
                    throw new Error('No answers were generated. Please try again.');
                }
                
                renderAnswersSheet(classValue, subjectModule, answersText);
                
                // Force show the answers area
                answersArea.classList.remove('hidden');
                answersArea.style.display = 'block';
                
                console.log('Answers area should be visible now');
                console.log('Answers area display style:', window.getComputedStyle(answersArea).display);
                console.log('Answers sheet content length:', answersSheet.innerHTML.length);
                
                showStatus('Successfully generated answers!', false);
            } catch (error) {
                console.error('Error generating answers:', error);
                showStatus(`Error: ${error.message}`, true);
            } finally {
                hideLoading();
                generateAnswersButton.disabled = false;
            }
        });

        // PDF export for answers button handler
        downloadAnswersPdfButton.addEventListener('click', () => {
            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const classValue = classInput.value;
                const subjectModule = subjectModuleInput.value;
                const date = new Date().toLocaleDateString('en-US', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });

                // Get answers text
                const answersText = answersSheet.textContent || answersSheet.innerText;

                doc.setFont('helvetica');
                
                // Title
                doc.setFontSize(18);
                doc.setFont('helvetica', 'bold');
                doc.text('Answer Key', 105, 20, { align: 'center' });
                
                // Class, Subject, Date
                doc.setFontSize(11);
                doc.setFont('helvetica', 'normal');
                doc.text(`Class: ${classValue}`, 105, 30, { align: 'center' });
                doc.text(`Subject Module: ${subjectModule}`, 105, 36, { align: 'center' });
                doc.text(`Date: ${date}`, 105, 42, { align: 'center' });
                
                // Answers
                let yPos = 55;
                doc.setFontSize(10);
                
                const paragraphs = answersText.split('\n').filter(p => p.trim());
                
                paragraphs.forEach(para => {
                    if (yPos > 270) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    const lines = doc.splitTextToSize(para.trim(), 180);
                    lines.forEach(line => {
                        if (yPos > 270) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, 15, yPos);
                        yPos += 5;
                    });
                    
                    yPos += 2;
                });
                
                // Footer
                const pageCount = doc.internal.pages.length - 1;
                for (let i = 1; i <= pageCount; i++) {
                    doc.setPage(i);
                    doc.setFontSize(9);
                    doc.text('Answer Key', 105, 285, { align: 'center' });
                }
                
                // Save PDF
                const fileName = `AnswerKey_${classValue.replace(/\s+/g, '_')}_${date.replace(/\s+/g, '_')}.pdf`;
                doc.save(fileName);
                showStatus("Answers PDF exported successfully!", false);
            } catch (error) {
                console.error('Error exporting answers PDF:', error);
                showStatus(`Error exporting PDF: ${error.message}`, true);
            }
        });
    </script>
</body>
</html>

