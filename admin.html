<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Workers Clock</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Inter font and custom styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #10b981, #059669, #34d399, #6ee7b7);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th:first-child, td:first-child {
            position: sticky;
            left: 0;
            background-color: white;
            z-index: 10;
        }
        
        tr:hover th:first-child, tr:hover td:first-child {
            background-color: #f9fafb;
        }
        
        thead th:first-child {
            background-color: #ecfdf5;
            z-index: 20;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    
    <div class="w-full max-w-7xl mx-auto">
        <!-- Back Button -->
        <a href="index.html" 
           class="inline-flex items-center text-sm text-white hover:text-emerald-100 font-medium mb-4 transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Home
        </a>
        
        <!-- Main Dashboard Card -->
        <div class="glass rounded-3xl shadow-2xl p-6 md:p-8">
            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6">
                <div>
                    <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-2">Admin Dashboard</h1>
                    <p class="text-gray-600" id="date-display">Loading...</p>
                </div>
                <button onclick="refreshData()" 
                        class="mt-4 md:mt-0 px-6 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors">
                    <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            
            <!-- Stats Summary -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <div class="bg-emerald-50 border border-emerald-200 rounded-xl p-4">
                    <p class="text-sm text-emerald-600 font-medium">Total Records</p>
                    <p class="text-3xl font-bold text-emerald-800" id="total-records">0</p>
                </div>
                <div class="bg-blue-50 border border-blue-200 rounded-xl p-4">
                    <p class="text-sm text-blue-600 font-medium">Check Ins</p>
                    <p class="text-3xl font-bold text-blue-800" id="check-ins">0</p>
                </div>
                <div class="bg-red-50 border border-red-200 rounded-xl p-4">
                    <p class="text-sm text-red-600 font-medium">Check Outs</p>
                    <p class="text-3xl font-bold text-red-800" id="check-outs">0</p>
                </div>
            </div>
            
            <!-- Search and Filter Section -->
            <div id="filter-section" class="hidden mb-6 bg-white border border-gray-200 rounded-xl p-4 shadow-sm">
                <div class="flex flex-col md:flex-row gap-4">
                    <!-- Name Search -->
                    <div class="flex-1">
                        <label for="filter-name" class="block text-sm font-medium text-gray-700 mb-2">Search by Name</label>
                        <input type="text" 
                               id="filter-name" 
                               placeholder="Enter worker name..."
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               oninput="applyFilters()">
                    </div>
                    
                    <!-- Date Filter -->
                    <div class="flex-1">
                        <label for="filter-date" class="block text-sm font-medium text-gray-700 mb-2">Filter by Date</label>
                        <input type="date" 
                               id="filter-date" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               onchange="applyFilters()">
                    </div>
                    
                    <!-- Month Filter -->
                    <div class="flex-1">
                        <label for="filter-month" class="block text-sm font-medium text-gray-700 mb-2">Filter by Month</label>
                        <input type="month" 
                               id="filter-month" 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                               onchange="applyFilters()">
                    </div>
                    
                    <!-- Clear Filters Button -->
                    <div class="flex items-end">
                        <button onclick="clearFilters()" 
                                class="px-6 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors whitespace-nowrap">
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center py-8">
                <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
                <p class="mt-2 text-gray-600">Loading records...</p>
            </div>
            
            <!-- Error Message -->
            <div id="error-message" class="hidden p-4 bg-red-50 border border-red-200 rounded-lg text-red-800 mb-4">
                <p id="error-text"></p>
            </div>
            
            <!-- Delete Action Bar -->
            <div id="delete-action-bar" class="hidden mb-4 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span id="selected-count" class="font-semibold text-red-800">0</span>
                    <span class="text-red-700">record(s) selected</span>
                </div>
                <button onclick="deleteSelectedRecords()" 
                        class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors flex items-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                    </svg>
                    Delete Selected
                </button>
            </div>
            
            <!-- Records Table -->
            <div id="records-container" class="hidden overflow-x-auto rounded-lg border border-gray-200 shadow-sm">
                <table class="min-w-full bg-white">
                    <thead class="bg-emerald-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap w-12">
                                <input type="checkbox" id="select-all-checkbox" class="w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500" onchange="toggleSelectAll(this.checked)">
                            </th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap">Name</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap">Check-in Time</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap">Check-out Time</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap">Check-in Image</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap">Check-out Image</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap">Location Check-in</th>
                            <th class="px-4 py-3 text-left text-xs font-semibold text-emerald-800 uppercase tracking-wider border-b border-emerald-200 whitespace-nowrap">Location Check-out</th>
                        </tr>
                    </thead>
                    <tbody id="records-table-body" class="divide-y divide-gray-200">
                        <!-- Records will be inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- No Records Message -->
            <div id="no-records" class="hidden text-center py-12">
                <svg class="w-16 h-16 text-gray-400 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="text-gray-500 text-lg" id="no-records-message">No records found</p>
            </div>
        </div>
    </div>
    
    <script>
        // Backend API URL - automatically uses current domain (works for localhost and Render)
        const BACKEND_API_URL = window.location.origin;
        
        // Check admin authentication
        const isAuthenticated = sessionStorage.getItem('adminAuthenticated') === 'true';
        if (!isAuthenticated) {
            alert('Access denied. Please login from the home page.');
            window.location.href = 'index.html';
        }
        
        // Set current date
        const today = new Date();
        const dateString = today.toLocaleDateString('en-US', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });
        document.getElementById('date-display').textContent = dateString;
        
        // Global variable to store all records
        let allRecords = [];
        
        // Get today's date in ISO format (YYYY-MM-DD)
        function getTodayISO() {
            const today = new Date();
            return today.toISOString().split('T')[0];
        }
        
        // Load all records from API
        async function loadTodayRecords() {
            const loadingIndicator = document.getElementById('loading-indicator');
            const recordsContainer = document.getElementById('records-container');
            const noRecords = document.getElementById('no-records');
            const errorMessage = document.getElementById('error-message');
            const errorText = document.getElementById('error-text');
            
            loadingIndicator.classList.remove('hidden');
            recordsContainer.classList.add('hidden');
            noRecords.classList.add('hidden');
            errorMessage.classList.add('hidden');
            
            try {
                // Fetch all records with addresses
                const response = await fetch(`${BACKEND_API_URL}/api/clock?limit=1000&include_address=true`);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const records = await response.json();
                
                // Store all records globally
                allRecords = records;
                
                // Sort by timestamp (newest first)
                allRecords.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
                
                // Show filter section
                document.getElementById('filter-section').classList.remove('hidden');
                
                // Set default to today's date
                const today = getTodayISO();
                document.getElementById('filter-date').value = today;
                
                // Apply filters (will show today's records by default)
                applyFilters();
                
                loadingIndicator.classList.add('hidden');
                
            } catch (error) {
                console.error('Error loading records:', error);
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
                errorText.textContent = `Failed to load records: ${error.message}. Make sure the backend API is running.`;
            }
        }
        
        // Display records in table format grouped by worker
        function displayRecords(records) {
            const tableBody = document.getElementById('records-table-body');
            tableBody.innerHTML = '';
            
            // Group records by worker name
            const workersMap = new Map();
            
            records.forEach(record => {
                if (!workersMap.has(record.worker_name)) {
                    workersMap.set(record.worker_name, {
                        checkIns: [],
                        checkOuts: []
                    });
                }
                
                if (record.action === 'check-in') {
                    workersMap.get(record.worker_name).checkIns.push(record);
                } else if (record.action === 'check-out') {
                    workersMap.get(record.worker_name).checkOuts.push(record);
                }
            });
            
            // Sort check-ins and check-outs by timestamp for each worker
            workersMap.forEach((data, workerName) => {
                data.checkIns.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
                data.checkOuts.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            });
            
            // Create table rows - pair check-ins with check-outs
            workersMap.forEach((data, workerName) => {
                const maxPairs = Math.max(data.checkIns.length, data.checkOuts.length);
                
                for (let i = 0; i < maxPairs; i++) {
                    const checkIn = data.checkIns[i] || null;
                    const checkOut = data.checkOuts[i] || null;
                    
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50 transition-colors';
                    
                    // Format time
                    const formatTime = (record) => {
                        if (!record) return '-';
                        return new Date(record.timestamp).toLocaleTimeString('en-US', {
                            hour: '2-digit',
                            minute: '2-digit',
                            second: '2-digit'
                        });
                    };
                    
                    // Format location - use address if available, otherwise show coordinates
                    const formatLocation = (record) => {
                        if (!record || !record.latitude || !record.longitude) {
                            return '-';
                        }
                        
                        const coordText = `${record.latitude.toFixed(6)}, ${record.longitude.toFixed(6)}`;
                        
                        // If address is available from API response, use it
                        if (record.address && record.address !== '-' && !record.address.startsWith('Error')) {
                            return `<div class="text-xs"><div class="font-medium text-gray-700">${record.address}</div><div class="text-gray-400 mt-1">${coordText}</div></div>`;
                        }
                        
                        // Otherwise just show coordinates
                        return `<span class="text-xs text-gray-600">${coordText}</span>`;
                    };
                    
                    // Collect record IDs for this row (check-in and/or check-out)
                    const recordIds = [];
                    if (checkIn) recordIds.push(checkIn.id);
                    if (checkOut) recordIds.push(checkOut.id);
                    const rowId = `row-${recordIds.join('-')}`;
                    
                    row.id = rowId;
                    row.setAttribute('data-record-ids', JSON.stringify(recordIds));
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" class="row-checkbox w-4 h-4 text-emerald-600 border-gray-300 rounded focus:ring-emerald-500" 
                                   data-row-id="${rowId}" 
                                   onchange="updateSelection()">
                        </td>
                        <td class="px-4 py-3 text-sm font-semibold text-gray-800 ${i === 0 ? '' : 'text-gray-500'} whitespace-nowrap">
                            ${i === 0 ? workerName : ''}
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${formatTime(checkIn)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700 whitespace-nowrap">${formatTime(checkOut)}</td>
                        <td class="px-4 py-3">
                            <div id="checkin-image-${checkIn ? checkIn.id : 'none'}" class="w-20 h-20 bg-gray-100 rounded border border-gray-200 overflow-hidden flex items-center justify-center mx-auto">
                                ${checkIn && checkIn.encrypted_image ? 
                                    '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-400"></div>' : 
                                    '<span class="text-xs text-gray-400">-</span>'}
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div id="checkout-image-${checkOut ? checkOut.id : 'none'}" class="w-20 h-20 bg-gray-100 rounded border border-gray-200 overflow-hidden flex items-center justify-center mx-auto">
                                ${checkOut && checkOut.encrypted_image ? 
                                    '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-gray-400"></div>' : 
                                    '<span class="text-xs text-gray-400">-</span>'}
                            </div>
                        </td>
                        <td class="px-4 py-3 text-sm text-gray-600">${formatLocation(checkIn)}</td>
                        <td class="px-4 py-3 text-sm text-gray-600">${formatLocation(checkOut)}</td>
                    `;
                    
                    tableBody.appendChild(row);
                    
                    // Load images asynchronously
                    if (checkIn && checkIn.encrypted_image) {
                        loadImage(checkIn.id, `checkin-image-${checkIn.id}`);
                    }
                    if (checkOut && checkOut.encrypted_image) {
                        loadImage(checkOut.id, `checkout-image-${checkOut.id}`);
                    }
                }
            });
        }
        
        // Load decrypted image
        async function loadImage(recordId, imageElementId) {
            try {
                const response = await fetch(`${BACKEND_API_URL}/api/clock/${recordId}/image`);
                
                if (!response.ok) {
                    throw new Error('Failed to load image');
                }
                
                const data = await response.json();
                const imageDiv = document.getElementById(imageElementId);
                
                if (data.image && imageDiv) {
                    imageDiv.innerHTML = `
                        <img src="${data.image}" alt="Worker photo" class="w-full h-full object-cover">
                    `;
                } else if (imageDiv) {
                    imageDiv.innerHTML = `
                        <span class="text-xs text-gray-400">N/A</span>
                    `;
                }
            } catch (error) {
                console.error(`Error loading image for record ${recordId}:`, error);
                const imageDiv = document.getElementById(imageElementId);
                if (imageDiv) {
                    imageDiv.innerHTML = `
                        <span class="text-xs text-red-400">Error</span>
                    `;
                }
            }
        }
        
        // Apply filters to records
        function applyFilters() {
            if (!allRecords || allRecords.length === 0) {
                return; // No records loaded yet
            }
            
            const nameFilter = document.getElementById('filter-name').value.toLowerCase().trim();
            const dateFilter = document.getElementById('filter-date').value;
            const monthFilter = document.getElementById('filter-month').value;
            
            let filteredRecords = [...allRecords];
            
            // Filter by name
            if (nameFilter) {
                filteredRecords = filteredRecords.filter(record => 
                    record.worker_name.toLowerCase().includes(nameFilter)
                );
            }
            
            // Filter by date (exact date match)
            if (dateFilter) {
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                    return recordDate === dateFilter;
                });
            }
            
            // Filter by month (YYYY-MM format)
            if (monthFilter && !dateFilter) {
                filteredRecords = filteredRecords.filter(record => {
                    const recordDate = new Date(record.timestamp).toISOString().split('T')[0];
                    const recordMonth = recordDate.substring(0, 7); // YYYY-MM
                    return recordMonth === monthFilter;
                });
            }
            
            // Update stats
            document.getElementById('total-records').textContent = filteredRecords.length;
            document.getElementById('check-ins').textContent = filteredRecords.filter(r => r.action === 'check-in').length;
            document.getElementById('check-outs').textContent = filteredRecords.filter(r => r.action === 'check-out').length;
            
            // Display filtered records
            const recordsContainer = document.getElementById('records-container');
            const noRecords = document.getElementById('no-records');
            const noRecordsMessage = document.getElementById('no-records-message');
            
            if (filteredRecords.length === 0) {
                recordsContainer.classList.add('hidden');
                noRecords.classList.remove('hidden');
                
                // Custom message based on filters
                if (nameFilter || dateFilter || monthFilter) {
                    noRecordsMessage.textContent = 'No records found matching your filters';
                } else {
                    noRecordsMessage.textContent = 'No records found';
                }
            } else {
                noRecords.classList.add('hidden');
                displayRecords(filteredRecords);
                recordsContainer.classList.remove('hidden');
            }
        }
        
        // Clear all filters
        function clearFilters() {
            document.getElementById('filter-name').value = '';
            document.getElementById('filter-date').value = '';
            document.getElementById('filter-month').value = '';
            
            // Set default to today's date
            const today = getTodayISO();
            document.getElementById('filter-date').value = today;
            
            applyFilters();
        }
        
        // Toggle select all checkboxes
        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.row-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
            });
            updateSelection();
        }
        
        // Update selection count and show/hide delete bar
        function updateSelection() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            const selectedCount = checkboxes.length;
            const deleteBar = document.getElementById('delete-action-bar');
            const selectedCountSpan = document.getElementById('selected-count');
            
            selectedCountSpan.textContent = selectedCount;
            
            if (selectedCount > 0) {
                deleteBar.classList.remove('hidden');
            } else {
                deleteBar.classList.add('hidden');
            }
        }
        
        // Delete selected records
        async function deleteSelectedRecords() {
            const checkboxes = document.querySelectorAll('.row-checkbox:checked');
            
            if (checkboxes.length === 0) {
                alert('Please select at least one record to delete');
                return;
            }
            
            // Confirm deletion
            const confirmMessage = `Are you sure you want to delete ${checkboxes.length} record(s)? This action cannot be undone.`;
            if (!confirm(confirmMessage)) {
                return;
            }
            
            // Collect all record IDs from selected rows
            const recordIds = new Set();
            checkboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row) {
                    const rowRecordIds = JSON.parse(row.getAttribute('data-record-ids') || '[]');
                    rowRecordIds.forEach(id => recordIds.add(id));
                }
            });
            
            const idsArray = Array.from(recordIds);
            
            try {
                const response = await fetch(`${BACKEND_API_URL}/api/clock/bulk`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ record_ids: idsArray })
                });
                
                if (!response.ok) {
                    let errorMessage = 'Failed to delete records';
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.detail || errorData.message || errorMessage;
                    } catch (e) {
                        errorMessage = `HTTP ${response.status}: ${response.statusText}`;
                    }
                    throw new Error(errorMessage);
                }
                
                const result = await response.json();
                
                // Show success message
                alert(`Successfully deleted ${result.deleted_count} record(s)`);
                
                // Refresh the data
                await loadTodayRecords();
                
                // Reset selection
                document.getElementById('select-all-checkbox').checked = false;
                updateSelection();
                
            } catch (error) {
                console.error('Error deleting records:', error);
                // Extract error message properly
                const errorMessage = error instanceof Error ? error.message : (error?.detail || error?.message || String(error) || 'Unknown error occurred');
                alert(`Error deleting records: ${errorMessage}`);
            }
        }
        
        // Refresh data
        function refreshData() {
            loadTodayRecords();
        }
        
        // Load data on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadTodayRecords();
        });
    </script>
</body>
</html>

