<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SQL Query Interface - Workers Clock</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load API Key Configuration -->
    <script src="config.js"></script>
    
    <!-- Load Inter font and custom styles -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(-45deg, #10b981, #059669, #34d399, #6ee7b7);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }
        
        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .glass {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        
        .code-editor {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
            tab-size: 4;
        }
        
        table {
            border-collapse: separate;
            border-spacing: 0;
        }
        
        th {
            position: sticky;
            top: 0;
            background-color: #f3f4f6;
            z-index: 10;
        }
    </style>
</head>
<body class="min-h-screen p-4">
    
    <div class="w-full max-w-7xl mx-auto">
        <!-- Back Button -->
        <a href="index.html" 
           class="inline-flex items-center text-sm text-white hover:text-emerald-100 font-medium mb-4 transition-colors duration-200">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Back to Home
        </a>
        
        <!-- Main Card -->
        <div class="glass rounded-3xl shadow-2xl p-6 md:p-8">
            <!-- Header -->
            <div class="mb-6">
                <h1 class="text-4xl md:text-5xl font-extrabold text-gray-800 mb-2">SQL Query Interface</h1>
                <p class="text-gray-600">Execute SQL queries on your Render database</p>
            </div>
            
            <!-- Database Info -->
            <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-xl">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-sm text-blue-600 font-medium">Database Status</p>
                        <p class="text-lg font-semibold text-blue-800" id="db-status">Checking...</p>
                    </div>
                    <button onclick="loadTables()" 
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors text-sm">
                        Refresh Tables
                    </button>
                </div>
            </div>
            
            <!-- Tables Sidebar and Query Editor -->
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-6">
                <!-- Tables List -->
                <div class="lg:col-span-1">
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <h3 class="text-lg font-semibold text-gray-800 mb-3">Tables</h3>
                        <div id="tables-list" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-sm text-gray-500">Loading tables...</p>
                        </div>
                    </div>
                </div>
                
                <!-- Query Editor -->
                <div class="lg:col-span-3">
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">
                            SQL Query
                        </label>
                        <textarea 
                            id="sql-query" 
                            class="w-full h-48 p-4 border border-gray-300 rounded-lg code-editor focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500"
                            placeholder="SELECT * FROM clock_records LIMIT 10;"
                        ></textarea>
                    </div>
                    
                    <!-- Query Options -->
                    <div class="mb-4 flex items-center gap-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="allow-write" class="mr-2">
                            <span class="text-sm text-gray-700">Allow Write Operations (INSERT, UPDATE, DELETE)</span>
                        </label>
                    </div>
                    
                    <!-- Action Buttons -->
                    <div class="flex gap-3 mb-4">
                        <button onclick="executeQuery()" 
                                class="px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium">
                            <svg class="w-5 h-5 inline-block mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Execute Query
                        </button>
                        <button onclick="clearQuery()" 
                                class="px-6 py-3 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition-colors font-medium">
                            Clear
                        </button>
                        <button onclick="formatQuery()" 
                                class="px-6 py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors font-medium">
                            Format SQL
                        </button>
                    </div>
                    
                    <!-- Quick Query Templates -->
                    <div class="mb-4">
                        <details class="bg-gray-50 rounded-lg p-3">
                            <summary class="cursor-pointer text-sm font-medium text-gray-700">Quick Query Templates</summary>
                            <div class="mt-3 space-y-2">
                                <button onclick="setQuery('SELECT * FROM clock_records ORDER BY created_at DESC LIMIT 10;')" 
                                        class="block w-full text-left px-3 py-2 text-sm bg-white rounded border border-gray-200 hover:bg-gray-50">
                                    üìã Get latest 10 records
                                </button>
                                <button onclick="setQuery('SELECT worker_name, COUNT(*) as total_records FROM clock_records GROUP BY worker_name;')" 
                                        class="block w-full text-left px-3 py-2 text-sm bg-white rounded border border-gray-200 hover:bg-gray-50">
                                    üë• Count records by worker
                                </button>
                                <button onclick="setQuery('SELECT action, COUNT(*) as count FROM clock_records GROUP BY action;')" 
                                        class="block w-full text-left px-3 py-2 text-sm bg-white rounded border border-gray-200 hover:bg-gray-50">
                                    üìä Count by action type
                                </button>
                                <button onclick="setQuery('SELECT * FROM clock_records WHERE worker_name = \'John Doe\' ORDER BY created_at DESC;')" 
                                        class="block w-full text-left px-3 py-2 text-sm bg-white rounded border border-gray-200 hover:bg-gray-50">
                                    üîç Find records for specific worker
                                </button>
                            </div>
                        </details>
                    </div>
                </div>
            </div>
            
            <!-- Results Section -->
            <div id="results-section" class="hidden">
                <div class="mb-4 p-4 bg-emerald-50 border border-emerald-200 rounded-xl">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-emerald-600 font-medium">Query Results</p>
                            <p class="text-lg font-semibold text-emerald-800" id="results-info"></p>
                        </div>
                        <button onclick="exportResults()" 
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors text-sm">
                            Export CSV
                        </button>
                    </div>
                </div>
                
                <!-- Results Table -->
                <div class="overflow-x-auto border border-gray-200 rounded-lg">
                    <table id="results-table" class="w-full text-sm">
                        <thead id="results-thead" class="bg-gray-50"></thead>
                        <tbody id="results-tbody" class="bg-white"></tbody>
                    </table>
                </div>
            </div>
            
            <!-- Error Section -->
            <div id="error-section" class="hidden mt-4 p-4 bg-red-50 border border-red-200 rounded-xl">
                <p class="text-sm text-red-600 font-medium mb-2">Error</p>
                <p class="text-red-800" id="error-message"></p>
            </div>
            
            <!-- Success Message (for write operations) -->
            <div id="success-section" class="hidden mt-4 p-4 bg-green-50 border border-green-200 rounded-xl">
                <p class="text-sm text-green-600 font-medium mb-2">Success</p>
                <p class="text-green-800" id="success-message"></p>
            </div>
            
            <!-- Image Comparison Section -->
            <div class="mt-8 pt-8 border-t border-gray-300">
                <h2 class="text-2xl font-bold text-gray-800 mb-4">Image Comparison Tool</h2>
                <p class="text-gray-600 mb-6">Upload two images to compare and verify if they show the same person</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                    <!-- Image 1 Upload -->
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image 1 (Reference)</label>
                        <input type="file" id="image1-upload" accept="image/*" class="mb-3 text-sm">
                        <div class="w-full h-48 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden flex items-center justify-center">
                            <img id="image1-preview" class="hidden w-full h-full object-contain" alt="Image 1 preview">
                            <span id="image1-placeholder" class="text-sm text-gray-400">No image selected</span>
                        </div>
                    </div>
                    
                    <!-- Image 2 Upload -->
                    <div class="bg-gray-50 rounded-xl p-4 border border-gray-200">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Image 2 (Verification)</label>
                        <input type="file" id="image2-upload" accept="image/*" class="mb-3 text-sm">
                        <div class="w-full h-48 bg-gray-100 rounded-lg border border-gray-200 overflow-hidden flex items-center justify-center">
                            <img id="image2-preview" class="hidden w-full h-full object-contain" alt="Image 2 preview">
                            <span id="image2-placeholder" class="text-sm text-gray-400">No image selected</span>
                        </div>
                    </div>
                </div>
                
                <!-- Compare Button -->
                <div class="mb-4">
                    <button onclick="compareImages()" 
                            id="compare-btn"
                            class="w-full md:w-auto px-6 py-3 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition-colors font-medium flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Compare Images
                    </button>
                </div>
                
                <!-- Comparison Result -->
                <div id="comparison-result" class="hidden mt-4">
                    <div class="p-4 rounded-xl border" id="comparison-result-content">
                        <!-- Result will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Backend API URL
        const BACKEND_API_URL = window.location.origin;
        
        // Store current results for export
        let currentResults = null;
        let currentColumns = null;
        
        // Load tables on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadTables();
            checkDatabaseStatus();
        });
        
        /**
         * Check database connection status
         */
        async function checkDatabaseStatus() {
            try {
                const response = await fetch(`${BACKEND_API_URL}/api/sql/tables`);
                if (response.ok) {
                    document.getElementById('db-status').textContent = 'Connected ‚úì';
                    document.getElementById('db-status').className = 'text-lg font-semibold text-green-600';
                } else {
                    throw new Error('Database connection failed');
                }
            } catch (error) {
                document.getElementById('db-status').textContent = 'Disconnected ‚úó';
                document.getElementById('db-status').className = 'text-lg font-semibold text-red-600';
            }
        }
        
        /**
         * Load list of tables
         */
        async function loadTables() {
            try {
                const response = await fetch(`${BACKEND_API_URL}/api/sql/tables`);
                const data = await response.json();
                
                const tablesList = document.getElementById('tables-list');
                if (data.tables && data.tables.length > 0) {
                    tablesList.innerHTML = data.tables.map(table => `
                        <button onclick="loadTableSchema('${table}')" 
                                class="w-full text-left px-3 py-2 text-sm bg-white rounded border border-gray-200 hover:bg-gray-50 hover:border-emerald-300 transition-colors">
                            üìä ${table}
                        </button>
                    `).join('');
                } else {
                    tablesList.innerHTML = '<p class="text-sm text-gray-500">No tables found</p>';
                }
            } catch (error) {
                document.getElementById('tables-list').innerHTML = 
                    '<p class="text-sm text-red-500">Error loading tables</p>';
            }
        }
        
        /**
         * Load table schema
         */
        async function loadTableSchema(tableName) {
            try {
                const response = await fetch(`${BACKEND_API_URL}/api/sql/table/${tableName}`);
                const data = await response.json();
                
                // Show schema in a modal or update query
                const schemaInfo = data.schema.map(col => 
                    `${col.name} (${col.type}${col.nullable ? '' : ' NOT NULL'})`
                ).join(', ');
                
                // Set query to SELECT from this table
                setQuery(`SELECT * FROM ${tableName} LIMIT 10;`);
                
                // Show schema info
                alert(`Table: ${tableName}\n\nColumns:\n${schemaInfo}`);
            } catch (error) {
                alert(`Error loading table schema: ${error.message}`);
            }
        }
        
        /**
         * Set query text
         */
        function setQuery(query) {
            document.getElementById('sql-query').value = query;
        }
        
        /**
         * Clear query
         */
        function clearQuery() {
            document.getElementById('sql-query').value = '';
            hideAllSections();
        }
        
        /**
         * Format SQL query (basic formatting)
         */
        function formatQuery() {
            const query = document.getElementById('sql-query').value;
            // Basic SQL formatting
            const formatted = query
                .replace(/\bSELECT\b/gi, '\nSELECT')
                .replace(/\bFROM\b/gi, '\nFROM')
                .replace(/\bWHERE\b/gi, '\nWHERE')
                .replace(/\bORDER BY\b/gi, '\nORDER BY')
                .replace(/\bGROUP BY\b/gi, '\nGROUP BY')
                .replace(/\bJOIN\b/gi, '\nJOIN')
                .replace(/\bLEFT JOIN\b/gi, '\nLEFT JOIN')
                .replace(/\bRIGHT JOIN\b/gi, '\nRIGHT JOIN')
                .replace(/\bINNER JOIN\b/gi, '\nINNER JOIN')
                .trim();
            document.getElementById('sql-query').value = formatted;
        }
        
        /**
         * Execute SQL query
         */
        async function executeQuery() {
            const query = document.getElementById('sql-query').value.trim();
            const allowWrite = document.getElementById('allow-write').checked;
            
            if (!query) {
                showError('Please enter a SQL query');
                return;
            }
            
            // Hide previous results
            hideAllSections();
            
            // Show loading
            const resultsSection = document.getElementById('results-section');
            resultsSection.classList.remove('hidden');
            document.getElementById('results-info').textContent = 'Executing query...';
            
            try {
                const response = await fetch(`${BACKEND_API_URL}/api/sql/execute`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        query: query,
                        allow_write: allowWrite
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    throw new Error(data.detail || 'Query execution failed');
                }
                
                if (data.success) {
                    // Check if it's a SELECT query with results
                    if (data.columns && data.rows) {
                        displayResults(data);
                    } else {
                        // It's a write operation (INSERT, UPDATE, DELETE)
                        showSuccess(data.message || `Query executed successfully. Rows affected: ${data.rows_affected || 0}`);
                    }
                }
            } catch (error) {
                showError(error.message || 'Error executing query');
            }
        }
        
        /**
         * Display query results
         */
        function displayResults(data) {
            currentResults = data.rows;
            currentColumns = data.columns;
            
            const resultsSection = document.getElementById('results-section');
            resultsSection.classList.remove('hidden');
            
            // Update info
            const infoText = `${data.row_count || 0} row(s) returned in ${data.execution_time_ms || 0}ms`;
            document.getElementById('results-info').textContent = infoText;
            
            if (data.warning) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'mt-2 p-2 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800';
                warningDiv.textContent = data.warning;
                document.getElementById('results-section').insertBefore(warningDiv, document.getElementById('results-section').querySelector('.overflow-x-auto'));
            }
            
            // Build table header
            const thead = document.getElementById('results-thead');
            thead.innerHTML = '<tr>' + 
                data.columns.map(col => `<th class="px-4 py-3 text-left text-xs font-semibold text-gray-700 uppercase tracking-wider border-b border-gray-200">${col}</th>`).join('') + 
                '</tr>';
            
            // Build table body
            const tbody = document.getElementById('results-tbody');
            if (data.rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="' + data.columns.length + '" class="px-4 py-8 text-center text-gray-500">No results found</td></tr>';
            } else {
                tbody.innerHTML = data.rows.map(row => 
                    '<tr class="hover:bg-gray-50 border-b border-gray-100">' +
                    data.columns.map(col => {
                        const value = row[col];
                        // Handle null values and long text
                        if (value === null || value === undefined) {
                            return '<td class="px-4 py-3 text-sm text-gray-500">NULL</td>';
                        }
                        const displayValue = String(value).length > 100 
                            ? String(value).substring(0, 100) + '...' 
                            : String(value);
                        return `<td class="px-4 py-3 text-sm text-gray-700">${escapeHtml(displayValue)}</td>`;
                    }).join('') +
                    '</tr>'
                ).join('');
            }
        }
        
        /**
         * Show error message
         */
        function showError(message) {
            hideAllSections();
            const errorSection = document.getElementById('error-section');
            errorSection.classList.remove('hidden');
            document.getElementById('error-message').textContent = message;
        }
        
        /**
         * Show success message
         */
        function showSuccess(message) {
            hideAllSections();
            const successSection = document.getElementById('success-section');
            successSection.classList.remove('hidden');
            document.getElementById('success-message').textContent = message;
        }
        
        /**
         * Hide all result sections
         */
        function hideAllSections() {
            document.getElementById('results-section').classList.add('hidden');
            document.getElementById('error-section').classList.add('hidden');
            document.getElementById('success-section').classList.add('hidden');
        }
        
        /**
         * Export results to CSV
         */
        function exportResults() {
            if (!currentResults || !currentColumns) {
                alert('No results to export');
                return;
            }
            
            // Create CSV content
            const csvRows = [];
            
            // Add header
            csvRows.push(currentColumns.join(','));
            
            // Add data rows
            currentResults.forEach(row => {
                const values = currentColumns.map(col => {
                    const value = row[col];
                    if (value === null || value === undefined) {
                        return '';
                    }
                    // Escape commas and quotes in CSV
                    const stringValue = String(value);
                    if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
                        return '"' + stringValue.replace(/"/g, '""') + '"';
                    }
                    return stringValue;
                });
                csvRows.push(values.join(','));
            });
            
            // Create download
            const csvContent = csvRows.join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `query_results_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        /**
         * Escape HTML
         */
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // Keyboard shortcut: Ctrl+Enter to execute
        document.getElementById('sql-query').addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'Enter') {
                executeQuery();
            }
        });
        
        // Image upload preview handlers
        document.getElementById('image1-upload').addEventListener('change', (e) => {
            handleImageUpload(e, 'image1-preview', 'image1-placeholder');
        });
        
        document.getElementById('image2-upload').addEventListener('change', (e) => {
            handleImageUpload(e, 'image2-preview', 'image2-placeholder');
        });
        
        function handleImageUpload(event, previewId, placeholderId) {
            const file = event.target.files[0];
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                    placeholder.classList.add('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }
        
        // Compare two images using Gemini API
        async function compareImages() {
            const image1Input = document.getElementById('image1-upload');
            const image2Input = document.getElementById('image2-upload');
            const compareBtn = document.getElementById('compare-btn');
            const resultDiv = document.getElementById('comparison-result');
            const resultContent = document.getElementById('comparison-result-content');
            
            // Validate inputs
            if (!image1Input.files[0] || !image2Input.files[0]) {
                alert('Please upload both images before comparing');
                return;
            }
            
            // Disable button and show loading
            compareBtn.disabled = true;
            const originalButtonHTML = compareBtn.innerHTML;
            compareBtn.innerHTML = '<div class="animate-spin rounded-full h-5 w-5 border-b-2 border-white inline-block mr-2"></div>Comparing...';
            
            resultDiv.classList.add('hidden');
            
            try {
                // Convert images to base64
                const image1Base64 = await fileToBase64(image1Input.files[0]);
                const image2Base64 = await fileToBase64(image2Input.files[0]);
                
                // Extract base64 data (remove data:image/...;base64, prefix)
                const image1Data = image1Base64.includes(',') ? image1Base64.split(',')[1] : image1Base64;
                const image2Data = image2Base64.includes(',') ? image2Base64.split(',')[1] : image2Base64;
                
                // Get API key from config
                const apiKey = CONFIG.getApiKey();
                if (!apiKey) {
                    throw new Error('API key not configured. Please set up your API key in config.js');
                }
                
                const modelName = 'gemini-2.0-flash-001';
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                
                const prompt = `You are comparing TWO images to verify if they show the SAME person.

IMAGE 1: Reference image
IMAGE 2: Verification image

INSTRUCTIONS:
1. First verify BOTH images show HUMAN FACES (not animals, objects, etc.)
2. Compare facial features: face shape, eyes, nose, mouth, jawline
3. Only if you are 95%+ CERTAIN they are the SAME person, respond: "VERIFIED: Same person"
4. If they are DIFFERENT people, or if you have ANY doubt, respond: "NOT_VERIFIED: [specific reason]"

CRITICAL: Be very strict. Different people = NOT_VERIFIED. Animals/objects = NOT_VERIFIED. Any doubt = NOT_VERIFIED.

Respond with ONLY one of these exact formats:
- "VERIFIED: Same person" (if same person, 95%+ certain)
- "NOT_VERIFIED: [reason]" (if different person, animal, object, or any doubt)`;
                
                const requestBody = {
                    contents: [{
                        parts: [
                            { text: prompt },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: image1Data
                                }
                            },
                            {
                                inline_data: {
                                    mime_type: "image/jpeg",
                                    data: image2Data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0.1,
                        maxOutputTokens: 200
                    }
                };
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error?.message || 'Comparison failed');
                }
                
                const data = await response.json();
                
                // Extract result text
                let resultText = '';
                if (data && data.candidates && Array.isArray(data.candidates) && data.candidates.length > 0) {
                    const candidate = data.candidates[0];
                    if (candidate && candidate.content && candidate.content.parts && Array.isArray(candidate.content.parts) && candidate.content.parts.length > 0) {
                        resultText = candidate.content.parts[0].text || '';
                    }
                }
                
                // Parse result - be strict
                const upperText = resultText.toUpperCase();
                const isVerified = upperText.includes('VERIFIED:') && 
                                  !upperText.includes('NOT_VERIFIED') &&
                                  !upperText.includes('DIFFERENT') &&
                                  !upperText.includes('ANIMAL');
                const isNotVerified = upperText.includes('NOT_VERIFIED') || 
                                     upperText.includes('DIFFERENT') ||
                                     upperText.includes('ANIMAL') ||
                                     upperText.includes('NOT A HUMAN');
                
                resultDiv.classList.remove('hidden');
                
                if (isVerified && !isNotVerified) {
                    // Verified
                    resultContent.className = 'p-4 rounded-xl border border-green-200 bg-green-50';
                    resultContent.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0">
                                <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-green-800 mb-2">‚úì Verified - Same Person</h3>
                                <p class="text-green-700 text-sm">The images show the same person.</p>
                                <p class="text-green-600 text-xs mt-2">Response: ${resultText}</p>
                            </div>
                        </div>
                    `;
                } else {
                    // Not verified
                    const reason = resultText.split('NOT_VERIFIED:')[1]?.trim() || 
                                  resultText.split('not verified')[1]?.trim() || 
                                  'Not verified - images show different subjects';
                    resultContent.className = 'p-4 rounded-xl border border-red-200 bg-red-50';
                    resultContent.innerHTML = `
                        <div class="flex items-start gap-3">
                            <div class="flex-shrink-0">
                                <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </div>
                            <div class="flex-1">
                                <h3 class="text-lg font-semibold text-red-800 mb-2">‚úó Not Verified</h3>
                                <p class="text-red-700 text-sm">${reason}</p>
                                <p class="text-red-600 text-xs mt-2">Response: ${resultText}</p>
                            </div>
                        </div>
                    `;
                }
                
            } catch (error) {
                console.error('Image comparison error:', error);
                resultDiv.classList.remove('hidden');
                resultContent.className = 'p-4 rounded-xl border border-red-200 bg-red-50';
                resultContent.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="flex-shrink-0">
                            <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h3 class="text-lg font-semibold text-red-800 mb-2">Error</h3>
                            <p class="text-red-700 text-sm">${error.message}</p>
                        </div>
                    </div>
                `;
            } finally {
                // Restore button
                compareBtn.disabled = false;
                compareBtn.innerHTML = originalButtonHTML;
            }
        }
        
        // Convert file to base64
        function fileToBase64(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        }
    </script>
</body>
</html>

